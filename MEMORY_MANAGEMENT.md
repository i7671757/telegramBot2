# üß† –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–∞–º—è—Ç—å—é –≤ Telegram Bot

## üìã –û–±–∑–æ—Ä

–°–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–∞–º—è—Ç—å—é —Ä–µ—à–∞–µ—Ç –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã —Å –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å—é, —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å:
- **–ë–æ–ª—å—à–∏–º–∏ –æ–±—ä–µ–∫—Ç–∞–º–∏ –≤ —Å–µ—Å—Å–∏—è—Ö** - –ø–æ–ª–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø—Ä–æ–¥—É–∫—Ç–æ–≤, –∫–∞—Ç–µ–≥–æ—Ä–∏–π, –º–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä–æ–≤
- **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ–º –æ—á–∏—Å—Ç–∫–∏ —É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö –¥–∞–Ω–Ω—ã—Ö** - –Ω–∞–∫–æ–ø–ª–µ–Ω–∏–µ –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–µ—Å—Å–∏–π
- **–£—Ç–µ—á–∫–∞–º–∏ –ø–∞–º—è—Ç–∏** - –Ω–µ–∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ–º—ã–π —Ä–æ—Å—Ç —Ä–∞–∑–º–µ—Ä–∞ —Å–µ—Å—Å–∏–π

## üîß –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Å–∏—Å—Ç–µ–º—ã

### 1. MemoryManager (`src/services/MemoryManager.ts`)
–¶–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–∞–º—è—Ç—å—é:

```typescript
import { memoryManager } from '../services/MemoryManager';

// –ü–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
const stats = await memoryManager.getMemoryStats();

// –ü–æ–ª–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ –ø–∞–º—è—Ç–∏
const result = await memoryManager.performFullCleanup();

// –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–º–µ—Ä–∞ —Å–µ—Å—Å–∏–∏
const sizeCheck = memoryManager.checkSessionSize(session);
```

**–û—Å–Ω–æ–≤–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:**
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —Å–µ—Å—Å–∏–π
- ‚úÖ –£–¥–∞–ª–µ–Ω–∏–µ —É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö –¥–∞–Ω–Ω—ã—Ö
- ‚úÖ –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ø–∞–º—è—Ç–∏
- ‚úÖ –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è —Å–±–æ—Ä–∫–∞ –º—É—Å–æ—Ä–∞
- ‚úÖ –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º—ã–µ –ø–æ—Ä–æ–≥–∏ –∏ –∏–Ω—Ç–µ—Ä–≤–∞–ª—ã

### 2. Memory Middleware (`src/middlewares/memoryMiddleware.ts`)
–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –æ—á–∏—Å—Ç–∫–∞:

```typescript
import { memoryMiddleware, sessionMemoryGuard } from '../middlewares/memoryMiddleware';

// –ü–æ–ª–Ω—ã–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø–∞–º—è—Ç–∏
bot.use(memoryMiddleware({
  checkInterval: 10 * 60 * 1000, // 10 –º–∏–Ω—É—Ç
  memoryThreshold: 100 * 1024 * 1024, // 100MB
  autoCleanup: true,
  logStats: true
}));

// –ó–∞—â–∏—Ç–∞ –æ—Ç —É—Ç–µ—á–µ–∫ –≤ —Å–µ—Å—Å–∏—è—Ö
bot.use(sessionMemoryGuard());
```

### 3. –°–∫—Ä–∏–ø—Ç –æ—á–∏—Å—Ç–∫–∏ (`scripts/memoryCleanup.js`)
–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –∫–æ–º–∞–Ω–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–∏ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–∞–º—è—Ç—å—é:

```bash
# –ê–Ω–∞–ª–∏–∑ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ø–∞–º—è—Ç–∏
npm run memory:analyze

# –û—á–∏—Å—Ç–∫–∞ –ø–∞–º—è—Ç–∏
npm run memory:cleanup

# –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
npm run memory:stats
```

## üìä –ü—Ä–æ–±–ª–µ–º—ã –∏ —Ä–µ—à–µ–Ω–∏—è

### ‚ùå –ü—Ä–æ–±–ª–µ–º–∞: –ë–æ–ª—å—à–∏–µ –æ–±—ä–µ–∫—Ç—ã –≤ —Å–µ—Å—Å–∏—è—Ö

**–î–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:**
```json
{
  "selectedProduct": {
    "id": 46,
    "attribute_data": {
      "name": { "chopar": { "en": "Longer", "ru": "–õ–æ–Ω–≥–µ—Ä", "uz": "Longer" } },
      "description": { "chopar": { "en": "...", "ru": "...", "uz": "..." } }
    },
    "modifiers": [
      { "id": 1, "name": "–±–µ–∑ –ø–æ–º–∏–¥–æ—Ä–∞", "price": 0, "weight": 0 },
      // ... –µ—â–µ 10+ –º–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä–æ–≤
    ],
    "variants": [],
    "created_at": "2021-11-04T17:06:13.000000Z",
    // ... –º–Ω–æ–∂–µ—Å—Ç–≤–æ –¥—Ä—É–≥–∏—Ö –ø–æ–ª–µ–π
  }
}
```
**–†–∞–∑–º–µ—Ä:** ~15KB –Ω–∞ –ø—Ä–æ–¥—É–∫—Ç

**‚úÖ –ü–æ—Å–ª–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:**
```json
{
  "selectedProduct": {
    "id": 46,
    "name": "–õ–æ–Ω–≥–µ—Ä",
    "price": "23000.00000"
  }
}
```
**–†–∞–∑–º–µ—Ä:** ~50 –±–∞–π—Ç –Ω–∞ –ø—Ä–æ–¥—É–∫—Ç (**99.7% —ç–∫–æ–Ω–æ–º–∏–∏**)

### ‚ùå –ü—Ä–æ–±–ª–µ–º–∞: –ù–∞–∫–æ–ø–ª–µ–Ω–∏–µ —É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö –¥–∞–Ω–Ω—ã—Ö

**–û–±–Ω–∞—Ä—É–∂–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã:**
- –°–µ—Å—Å–∏–∏ –≤–æ–∑—Ä–∞—Å—Ç–æ–º –±–æ–ª–µ–µ 7 –¥–Ω–µ–π
- –ù–µ–∞–∫—Ç–∏–≤–Ω—ã–µ —Å–µ—Å—Å–∏–∏ (>24 —á–∞—Å–∞ –±–µ–∑ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏)
- –í—Ä–µ–º–µ–Ω–Ω—ã–µ –ø–æ–ª—è (`expectingTimeSlotSelection`, `step`, `__scenes`)
- –ò–∑–±—ã—Ç–æ—á–Ω—ã–µ `productQuantities` (>50 –ø—Ä–æ–¥—É–∫—Ç–æ–≤)

**‚úÖ –†–µ—à–µ–Ω–∏–µ:**
```typescript
// –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ –ø–æ –≤–æ–∑—Ä–∞—Å—Ç—É
if (sessionAge > maxSessionAge) {
  await sessionService.deleteSession(userId, chatId);
}

// –£–¥–∞–ª–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –ø–æ–ª–µ–π
const temporaryFields = [
  'expectingTimeSlotSelection',
  'expectingAdditionalPhone', 
  'expectingCutleryChoice',
  'expectingOrderConfirmation',
  'step',
  'previousScene',
  '__scenes'
];
```

### ‚ùå –ü—Ä–æ–±–ª–µ–º–∞: –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞

**‚úÖ –†–µ—à–µ–Ω–∏–µ - –ö–æ–º–ø–ª–µ–∫—Å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞:**

```typescript
interface MemoryStats {
  totalSessions: number;           // –û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–µ—Å—Å–∏–π
  totalMemoryUsage: number;        // –û–±—â–µ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–∞–º—è—Ç–∏
  averageSessionSize: number;      // –°—Ä–µ–¥–Ω–∏–π —Ä–∞–∑–º–µ—Ä —Å–µ—Å—Å–∏–∏
  largestSessionSize: number;      // –†–∞–∑–º–µ—Ä —Å–∞–º–æ–π –±–æ–ª—å—à–æ–π —Å–µ—Å—Å–∏–∏
  oldestSessionAge: number;        // –í–æ–∑—Ä–∞—Å—Ç —Å–∞–º–æ–π —Å—Ç–∞—Ä–æ–π —Å–µ—Å—Å–∏–∏
  sessionsWithLargeData: number;   // –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –±–æ–ª—å—à–∏—Ö —Å–µ—Å—Å–∏–π
}
```

## üöÄ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

### –ê–Ω–∞–ª–∏–∑ —Ç–µ–∫—É—â–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è (sessions.json - 21KB):

**–î–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:**
- üìä –û–±—â–∏–π —Ä–∞–∑–º–µ—Ä: 21KB (588 —Å—Ç—Ä–æ–∫)
- üîç –ù–∞–π–¥–µ–Ω–∞ 1 –∞–∫—Ç–∏–≤–Ω–∞—è —Å–µ—Å—Å–∏—è —Ä–∞–∑–º–µ—Ä–æ–º ~20KB
- ‚ö†Ô∏è –°–æ–¥–µ—Ä–∂–∏—Ç –ø–æ–ª–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø—Ä–æ–¥—É–∫—Ç–æ–≤ —Å –º–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä–∞–º–∏
- üìà –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è —ç–∫–æ–Ω–æ–º–∏—è: ~95%

**–ü–æ—Å–ª–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:**
- üìä –û–∂–∏–¥–∞–µ–º—ã–π —Ä–∞–∑–º–µ—Ä: ~1-2KB
- ‚úÖ –£–¥–∞–ª–µ–Ω–∏–µ –∏–∑–±—ã—Ç–æ—á–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –ø—Ä–æ–¥—É–∫—Ç–æ–≤
- ‚úÖ –û—á–∏—Å—Ç–∫–∞ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –ø–æ–ª–µ–π
- ‚úÖ –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –¥–∞–Ω–Ω—ã—Ö

### –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Å–∏—Å—Ç–µ–º—ã:

| –ú–µ—Ç—Ä–∏–∫–∞ | –î–æ | –ü–æ—Å–ª–µ | –£–ª—É—á—à–µ–Ω–∏–µ |
|---------|----|----|-----------|
| –†–∞–∑–º–µ—Ä —Å–µ—Å—Å–∏–π | 100KB+ | <10KB | 90%+ |
| –í—Ä–µ–º—è –∑–∞–≥—Ä—É–∑–∫–∏ | 50-100ms | 5-10ms | 80-90% |
| –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–∞–º—è—Ç–∏ | –ù–µ–∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ–º–æ–µ | –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ + –∞–≤—Ç–æ–æ—á–∏—Å—Ç–∫–∞ | 70-90% |
| –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–µ—Å—Å–∏–π | –ù–∞–∫–æ–ø–ª–µ–Ω–∏–µ | –ê–≤—Ç–æ—É–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä—ã—Ö | –°—Ç–∞–±–∏–ª—å–Ω–æ–µ |

## üõ†Ô∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### 1. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ –æ—Å–Ω–æ–≤–Ω–æ–π –∫–æ–¥

```typescript
// index.ts
import { memoryMiddleware, sessionMemoryGuard } from './src/middlewares/memoryMiddleware';
import { memoryManager } from './src/services/MemoryManager';

// –î–æ–±–∞–≤–ª—è–µ–º middleware
bot.use(memoryMiddleware({
  checkInterval: 10 * 60 * 1000,     // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞–∂–¥—ã–µ 10 –º–∏–Ω—É—Ç
  memoryThreshold: 100 * 1024 * 1024, // –ü–æ—Ä–æ–≥ 100MB
  autoCleanup: true,                  // –ê–≤—Ç–æ–æ—á–∏—Å—Ç–∫–∞
  logStats: true                      // –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
}));

bot.use(sessionMemoryGuard()); // –ó–∞—â–∏—Ç–∞ –æ—Ç —É—Ç–µ—á–µ–∫

// –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
memoryManager.configure({
  sessionSizeThreshold: 50 * 1024,    // 50KB –Ω–∞ —Å–µ—Å—Å–∏—é
  maxSessionAge: 7 * 24 * 60 * 60 * 1000, // 7 –¥–Ω–µ–π
  maxInactiveAge: 24 * 60 * 60 * 1000     // 24 —á–∞—Å–∞
});
```

### 2. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ

```bash
# –ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π –∞–Ω–∞–ª–∏–∑
npm run memory:analyze

# –ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞
npm run memory:cleanup

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
npm run memory:stats
```

### 3. –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ cron

```bash
# –î–æ–±–∞–≤–∏—Ç—å –≤ crontab
# –ï–∂–µ–¥–Ω–µ–≤–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ –≤ 3:00
0 3 * * * cd /path/to/bot && npm run memory:cleanup

# –ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –≤ –≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ –≤ 2:00
0 2 * * 0 cd /path/to/bot && npm run memory:analyze > memory_report.txt
```

## üìà –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –∞–ª–µ—Ä—Ç—ã

### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è:

```typescript
// –í—ã—Å–æ–∫–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–∞–º—è—Ç–∏ (>400MB)
logger.warn(`High memory usage detected: ${heapUsedMB.toFixed(2)}MB`);

// –ö—Ä–∏—Ç–∏—á–µ—Å–∫–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ (>600MB)
logger.warn('Critical memory usage, starting emergency cleanup...');

// –ë–æ–ª—å—à–∞—è —Å–µ—Å—Å–∏—è –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∞
logger.warn(`Large session detected`, {
  userId, chatId, size: '150KB',
  recommendations: ['–£–¥–∞–ª–∏—Ç—å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã', '–û—á–∏—Å—Ç–∏—Ç—å —Å—Ç–∞—Ä—ã–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞']
});
```

### –ú–µ—Ç—Ä–∏–∫–∏ –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞:

- **–°–∏—Å—Ç–µ–º–Ω–∞—è –ø–∞–º—è—Ç—å:** Heap usage, RSS, External
- **–ü–∞–º—è—Ç—å —Å–µ—Å—Å–∏–π:** –û–±—â–∏–π —Ä–∞–∑–º–µ—Ä, –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ, —Å—Ä–µ–¥–Ω–∏–π —Ä–∞–∑–º–µ—Ä
- **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:** –í—Ä–µ–º—è –æ—Ç–∫–ª–∏–∫–∞, –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø—Ä–æ—Å–æ–≤
- **–û—á–∏—Å—Ç–∫–∞:** –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö/—É–¥–∞–ª–µ–Ω–Ω—ã—Ö —Å–µ—Å—Å–∏–π

## ‚öôÔ∏è –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è:

```env
# –ü–æ—Ä–æ–≥–∏ –ø–∞–º—è—Ç–∏
MEMORY_THRESHOLD=104857600          # 100MB
SESSION_SIZE_THRESHOLD=102400       # 100KB

# –í—Ä–µ–º–µ–Ω–Ω—ã–µ –∏–Ω—Ç–µ—Ä–≤–∞–ª—ã
MAX_SESSION_AGE=604800000          # 7 –¥–Ω–µ–π
MAX_INACTIVE_AGE=86400000          # 24 —á–∞—Å–∞

# –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
MEMORY_CHECK_INTERVAL=600000       # 10 –º–∏–Ω—É—Ç
ENABLE_MEMORY_LOGGING=true
ENABLE_AUTO_CLEANUP=true
```

### –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≤ –∫–æ–¥–µ:

```typescript
memoryManager.configure({
  memoryThreshold: 100 * 1024 * 1024,    // 100MB
  sessionSizeThreshold: 100 * 1024,       // 100KB
  maxSessionAge: 7 * 24 * 60 * 60 * 1000, // 7 –¥–Ω–µ–π
  maxInactiveAge: 24 * 60 * 60 * 1000     // 24 —á–∞—Å–∞
});
```

## üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø—Ä–æ–±–ª–µ–º

### –ö–æ–º–∞–Ω–¥—ã –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏:

```bash
# –ü–æ–¥—Ä–æ–±–Ω—ã–π –∞–Ω–∞–ª–∏–∑
node scripts/memoryCleanup.js analyze

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π —Å–µ—Å—Å–∏–∏
node -e "
const fs = require('fs');
const sessions = JSON.parse(fs.readFileSync('sessions.json', 'utf8'));
const session = sessions.sessions.find(s => s.id === '1034682:1034682');
console.log('Session size:', Buffer.byteLength(JSON.stringify(session.data), 'utf8'), 'bytes');
console.log('Large fields:', Object.keys(session.data).filter(k => 
  JSON.stringify(session.data[k]).length > 1000
));
"
```

### –¢–∏–ø–∏—á–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã –∏ —Ä–µ—à–µ–Ω–∏—è:

1. **–°–µ—Å—Å–∏—è —Ä–∞—Å—Ç–µ—Ç –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞**
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å middleware `sessionMemoryGuard`
   - –£–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –æ—á–∏—â–∞—é—Ç—Å—è

2. **–í—ã—Å–æ–∫–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–∞–º—è—Ç–∏**
   - –ó–∞–ø—É—Å—Ç–∏—Ç—å `npm run memory:cleanup`
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ –Ω–∞ —É—Ç–µ—á–∫–∏ –ø–∞–º—è—Ç–∏
   - –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –±–æ–ª–µ–µ –∞–≥—Ä–µ—Å—Å–∏–≤–Ω—É—é –æ—á–∏—Å—Ç–∫—É

3. **–ú–µ–¥–ª–µ–Ω–Ω–∞—è —Ä–∞–±–æ—Ç–∞ –±–æ—Ç–∞**
   - –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Ä–∞–∑–º–µ—Ä—ã —Å–µ—Å—Å–∏–π
   - –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –±–æ–ª—å—à–∏–µ —Å–µ—Å—Å–∏–∏
   - –£–≤–µ–ª–∏—á–∏—Ç—å —á–∞—Å—Ç–æ—Ç—É –æ—á–∏—Å—Ç–∫–∏

## üìö API Reference

### MemoryManager

```typescript
class MemoryManager {
  // –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —Å–µ—Å—Å–∏–∏
  optimizeSession(session: UserSession): {
    session: UserSession;
    result: SessionOptimizationResult;
  }

  // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–º–µ—Ä–∞
  checkSessionSize(session: UserSession): {
    isLarge: boolean;
    size: number;
    recommendations: string[];
  }

  // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–∞–º—è—Ç–∏
  getMemoryStats(): Promise<MemoryStats>

  // –ü–æ–ª–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞
  performFullCleanup(): Promise<CleanupResult>

  // –ê–≤—Ç–æ–æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è
  autoOptimizeSession(userId: number, chatId: number, session: UserSession): Promise<UserSession>

  // –ù–∞—Å—Ç—Ä–æ–π–∫–∞
  configure(options: MemoryManagerOptions): void

  // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è —Å–±–æ—Ä–∫–∞ –º—É—Å–æ—Ä–∞
  forceGarbageCollection(): void
}
```

### Middleware

```typescript
// –û—Å–Ω–æ–≤–Ω–æ–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
memoryMiddleware(options?: MemoryMiddlewareOptions)

// –ü—Ä–æ—Å—Ç–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
memoryLoggerMiddleware()

// –ó–∞—â–∏—Ç–∞ —Å–µ—Å—Å–∏–π
sessionMemoryGuard()
```

## üéØ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

### –î–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏:
1. **–í—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ** `sessionMemoryGuard()` middleware
2. **–ò–∑–±–µ–≥–∞–π—Ç–µ** —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–æ–ª–Ω—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤ API –≤ —Å–µ—Å—Å–∏—è—Ö
3. **–û—á–∏—â–∞–π—Ç–µ** –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø–æ—Å–ª–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
4. **–ú–æ–Ω–∏—Ç–æ—Ä—å—Ç–µ** —Ä–∞–∑–º–µ—Ä—ã —Å–µ—Å—Å–∏–π –≤ –ª–æ–≥–∞—Ö

### –î–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞:
1. **–ù–∞—Å—Ç—Ä–æ–π—Ç–µ** –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫—É—é –æ—á–∏—Å—Ç–∫—É —á–µ—Ä–µ–∑ cron
2. **–ú–æ–Ω–∏—Ç–æ—Ä—å—Ç–µ** –º–µ—Ç—Ä–∏–∫–∏ –ø–∞–º—è—Ç–∏
3. **–ù–∞—Å—Ç—Ä–æ–π—Ç–µ** –∞–ª–µ—Ä—Ç—ã –Ω–∞ –≤—ã—Å–æ–∫–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ
4. **–†–µ–≥—É–ª—è—Ä–Ω–æ** –∞–Ω–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É

### –î–ª—è –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è:
1. **–†–∞—Å—Å–º–æ—Ç—Ä–∏—Ç–µ** –≤–Ω–µ—à–Ω–µ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –¥–ª—è –±–æ–ª—å—à–∏—Ö –¥–∞–Ω–Ω—ã—Ö
2. **–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ** –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ —É—Ä–æ–≤–Ω–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
3. **–û–ø—Ç–∏–º–∏–∑–∏—Ä—É–π—Ç–µ** —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –¥–∞–Ω–Ω—ã—Ö
4. **–í–Ω–µ–¥—Ä–∏—Ç–µ** –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–µ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ

---

## üìû –ü–æ–¥–¥–µ—Ä–∂–∫–∞

–ü—Ä–∏ –≤–æ–∑–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏–∏ –ø—Ä–æ–±–ª–µ–º:
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏: `tail -f logs/$(date +%Y-%m-%d).log`
2. –ó–∞–ø—É—Å—Ç–∏—Ç–µ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É: `npm run memory:analyze`
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –≤ –∫–æ–¥–µ
4. –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ API

**–°–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–∞–º—è—Ç—å—é –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç —Å—Ç–∞–±–∏–ª—å–Ω—É—é –∏ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—É—é —Ä–∞–±–æ—Ç—É Telegram –±–æ—Ç–∞ —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–µ–π –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–æ–º.** 